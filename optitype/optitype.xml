<tool id="optitype" name="OptiType" version="1.3.5+galaxy0" profile="21.05">
    <description>HLA Class I typing from NGS data</description>
    <requirements>
        <requirement type="package" version="1.3.5">optitype</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
#if $fastq_input.fastq_input_selector == "paired":
    ln -s '$fastq_input.fastq_input1' input1.fastq &&
    ln -s '$fastq_input.fastq_input2' input2.fastq &&
    #set $input_str = 'input1.fastq input2.fastq'
#else:
    ln -s '$fastq_input.fastq_input1' input.fastq &&
    #set $input_str = 'input.fastq'
#end if

OptiTypePipeline.py
    --input $input_str
    $read_type
    --beta $beta
    --enumerate $enumerations
    --solver $solver
    --outdir .
    --prefix output
    #if $use_discordant:
        --discordant
    #end if
    --unpaired_weight $unpaired_weight

&& mv output_result.tsv '$tsv_output'
&& python3 << 'EOF'
import json
import csv

results = {}
with open('output_result.tsv', 'r') as f:
    reader = csv.DictReader(f, delimiter='\t')
    for row in reader:
        # OptiType output has columns like A1, A2, B1, B2, C1, C2
        for locus in ['A', 'B', 'C']:
            a1 = row.get(f'{locus}1', '')
            a2 = row.get(f'{locus}2', '')
            if a1:
                results[locus] = {
                    'allele1': f'{locus}*{a1}',
                    'allele2': f'{locus}*{a2}' if a2 else f'{locus}*{a1}',
                    'tool': 'OptiType',
                    'version': '1.3.5'
                }

output = {
    'sample': 'sample',
    'tool': 'OptiType',
    'version': '1.3.5',
    'typing_results': results
}

with open('$json_output', 'w') as f:
    json.dump(output, f, indent=2)
EOF
    ]]></command>
    <inputs>
        <conditional name="fastq_input">
            <param name="fastq_input_selector" type="select" label="Input type">
                <option value="paired" selected="true">Paired-end</option>
                <option value="single">Single-end</option>
            </param>
            <when value="paired">
                <param name="fastq_input1" type="data" format="fastq,fastqsanger,fastq.gz,fastqsanger.gz" label="FASTQ R1"/>
                <param name="fastq_input2" type="data" format="fastq,fastqsanger,fastq.gz,fastqsanger.gz" label="FASTQ R2"/>
            </when>
            <when value="single">
                <param name="fastq_input1" type="data" format="fastq,fastqsanger,fastq.gz,fastqsanger.gz" label="FASTQ"/>
            </when>
        </conditional>
        <param name="read_type" type="select" label="Sequencing type">
            <option value="--dna" selected="true">DNA</option>
            <option value="--rna">RNA</option>
        </param>
        <param name="beta" type="float" value="0.009" label="Beta" help="The beta parameter for the objective function"/>
        <param name="enumerations" type="integer" value="1" label="Enumerations" help="Number of optimal solutions to output"/>
        <param name="solver" type="select" label="Solver">
            <option value="glpk" selected="true">GLPK</option>
            <option value="cbc">CBC</option>
        </param>
        <param name="unpaired_weight" type="float" value="0.0" label="Unpaired weight" help="Weight for unpaired reads"/>
        <param name="use_discordant" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Use discordant reads"/>
    </inputs>
    <outputs>
        <data name="tsv_output" format="tabular" label="${tool.name} on ${on_string}: Result"/>
        <data name="json_output" format="json" label="${tool.name} on ${on_string}: JSON Result"/>
    </outputs>
    <help><![CDATA[
**OptiType: Precision HLA typing from next-generation sequencing data**

OptiType is a novel HLA genotyping algorithm based on integer linear programming, capable of producing accurate 4-digit HLA typing predictions from NGS data by simultaneously selecting the combinations of HLA alleles that maximize the number of mapped reads.

**Supported HLA Genes**

- HLA-A
- HLA-B
- HLA-C

**References**

Szolek, A., et al. (2014) OptiType: precision HLA typing from next-generation sequencing data. Bioinformatics, 30(23):3310-3316.
    ]]></help>
</tool>
