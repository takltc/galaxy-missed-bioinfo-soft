<tool id="expansionhunter_denovo_merge" name="ExpansionHunter Denovo Merge" version="0.9.0+galaxy0" profile="21.05">
    <description>Merge multiple STR profiles for cohort analysis</description>
    <macros>
        <token name="@TOOL_VERSION@">0.9.0</token>
        <token name="@GALAXY_VERSION@">galaxy0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">expansionhunterdenovo</requirement>
        <container type="docker">quay.io/biocontainers/expansionhunterdenovo:0.9.0--h6ac36c1_11</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #import os
        #set $manifest_content = ""
        #for $i, $profile in enumerate($profiles):
            #set $sample_name = str($profile.element_identifier) if $profile.element_identifier else "sample_" + str($i)
            #set $manifest_content += $sample_name + "\t" + str($profile) + "\n"
        #end for
        
        echo '${manifest_content}' > manifest.tsv &&
        
        python3 \$CONDA_PREFIX/share/ExpansionHunterDenovo-@TOOL_VERSION@/scripts/merge_profiles.py
            --manifest manifest.tsv
            --reference '$reference.fields.path'
            --output-prefix merged
    ]]></command>
    <inputs>
        <param name="profiles" type="data" format="json" multiple="true" label="STR Profiles" help="Multiple STR profile JSON files from the profile step"/>
        <param name="reference" type="select" label="Reference genome">
            <options from_data_table="fasta_indexes"/>
        </param>
    </inputs>
    <outputs>
        <data name="multisample_profile" format="json" from_work_dir="merged.multisample_profile.json" label="${tool.name} on ${on_string}: Multisample Profile"/>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="profiles" value="profile1.json,profile2.json,profile3.json"/>
            <param name="reference" value="hg38"/>
            <output name="multisample_profile" file="expected_merged.json" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
**ExpansionHunter Denovo - Merge**
===================================

Merge multiple STR profiles from individual samples into a single multisample profile for cohort analysis.

**Overview**
------------

This step combines STR profiles from multiple samples, enabling:

- Case-control analysis for repeat enrichment
- Outlier detection for heterogeneous cohorts
- Population-level repeat characterization

**Inputs**
----------

- **STR Profiles**: Multiple JSON profile files generated by the ``profile`` command
- **Reference genome**: Same reference used for profile generation

**Output**
----------

- **Multisample Profile (JSON)**: Combined profile with depth-normalized counts across all samples

**Workflow**
------------

1. Run ``profile`` on each sample
2. Use ``merge`` to combine all profiles
3. Run ``locus`` or ``outlier`` analysis

**Citation**
------------

Dolzhenko E, et al. ExpansionHunter Denovo: a computational method for locating known and novel repeat expansions in short-read sequencing data. Genome Biol. 2020;21(1):102.

    ]]></help>
    <citations>
        <citation type="doi">10.1186/s13059-020-02017-z</citation>
    </citations>
</tool>
