<tool id="haplocheck" name="Haplocheck" version="1.3.3+galaxy0" profile="21.05">
    <description>Detect in-sample contamination in mtDNA and WGS studies</description>
    <macros>
        <token name="@TOOL_VERSION@">1.3.3</token>
        <token name="@GALAXY_VERSION@">galaxy0</token>
    </macros>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">haplocheck</requirement>
        <container type="docker">omniverse/haplocheck:1.3.3</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        mkdir -p output &&
        
        #if str($input_vcf.ext) == "vcf_bgzip":
            gunzip -c '$input_vcf' > input.vcf &&
        #else:
            ln -s '$input_vcf' input.vcf &&
        #end if
        
        haplocheck
            --out output
            #if $output_raw:
                --raw
            #end if
            input.vcf
        
        && mv output/contamination.txt '$contamination_report'
        
        #if $output_raw:
            && mv output/contamination.raw.txt '$contamination_raw'
        #end if
        
        #if $output_html:
            && mv output/report/report.html '$html_report'
        #end if
    ]]></command>
    <inputs>
        <param name="input_vcf" type="data" format="vcf,vcf_bgzip" label="Input VCF file" help="VCF file with mtDNA variants. Homoplasmies should be coded as 1/1, heteroplasmies as 0/1. Can be generated by Mutserve or GATK MuTect2."/>
        
        <param name="output_raw" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Output raw data" help="Generate detailed raw data file with additional metrics (contamination.raw.txt)."/>
        
        <param name="output_html" type="boolean" truevalue="true" falsevalue="false" checked="true" label="Output HTML report" help="Generate interactive HTML report with phylogenetic tree visualization."/>
    </inputs>
    <outputs>
        <data name="contamination_report" format="tabular" label="${tool.name} on ${on_string}: Contamination Report"/>
        
        <data name="contamination_raw" format="tabular" label="${tool.name} on ${on_string}: Raw Data">
            <filter>output_raw</filter>
        </data>
        
        <data name="html_report" format="html" label="${tool.name} on ${on_string}: Interactive Report">
            <filter>output_html</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="input_vcf" value="test_mtdna.vcf"/>
            <param name="output_raw" value="false"/>
            <param name="output_html" value="true"/>
            <output name="contamination_report" file="expected_contamination.txt" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
**Haplocheck - Phylogeny-based Contamination Detection**
=========================================================

Haplocheck detects in-sample contamination in mtDNA and whole-genome sequencing (WGS) 
studies by analyzing the mitochondrial DNA content. It identifies contamination by 
detecting phylogenetically incompatible mitochondrial haplotypes observable as 
heteroplasmic (polymorphic) sites.

**Overview**
------------

Within-species contamination is a major issue in sequencing studies, especially for 
mitochondrial studies. Haplocheck uses the mitochondrial phylogeny and the concept of 
haplogroups to identify contamination:

1. Splits heteroplasmic variants into major and minor haplotype profiles
2. Classifies each profile into haplogroups using HaploGrep
3. Calculates phylogenetic distance between the two haplogroups
4. Reports contamination if two stable, distinct haplogroups are detected

**Applications**
----------------

- **Quality Control**: Detect sample contamination before downstream analysis
- **mtDNA Studies**: Essential QC for heteroplasmy studies
- **WGS Studies**: Fast proxy for nuclear DNA contamination detection
- **Forensic Genetics**: Sample authentication
- **Ancient DNA**: Contamination assessment (requires sufficient coverage)

**Input Requirements**
----------------------

- **VCF file**: Variants called from mtDNA or extracted from WGS data
  - Homoplasmies: Coded as "1/1" genotype
  - Heteroplasmies: Coded as "0/1" genotype with AF (allele frequency) tag
  
Recommended to generate VCF using:

- **Mutserve**: Specialized mtDNA variant caller (available in Galaxy)
- **GATK MuTect2**: For WGS data with mitochondrial pipeline

**Output Files**
----------------

1. **Contamination Report** (contamination.txt): Main results file with:
   - Sample ID
   - Contamination Status (YES/NO/ND)
   - Contamination Level (0-100%)
   - Major/Minor Haplogroups
   - Phylogenetic Distance

2. **Raw Data** (optional): Extended metrics including:
   - Heteroplasmy levels
   - Haplogroup quality scores
   - Cluster information

3. **HTML Report** (optional): Interactive visualization with:
   - Searchable/sortable results table
   - Phylogenetic tree for each sample
   - Visual contamination analysis

**Contamination Scenarios**
---------------------------

Haplocheck detects three contamination scenarios:

- **Scenario A**: Two haplotypes branch into distinct lineages
- **Scenario B**: Minor haplotype is ancestral to major
- **Scenario C**: Major haplotype is ancestral to minor

**Benchmark Performance**
-------------------------

According to García-Olivares et al. (2021) Sci Rep:

- Haplocheck stands out as the most complete tool for mtDNA haplogroup classification
- Accurate for both WGS and WES data
- Works with short-read and long-read (Nanopore) sequencing

**Best Practices**
------------------

Based on literature (PMID: 33452015):

1. **Coverage**: Minimum 100x for 10% contamination, 600x for 1% detection
2. **mtDNA Copy Number**: Consider when extrapolating to nDNA contamination
3. **Tissue Type**: Different tissues have varying mtDNA copy numbers
4. **Quality Thresholds**: Haplogroup quality ≥0.5 required for reliable detection

**Limitations**
---------------

- Cannot detect contamination between samples with identical haplogroups (e.g., mother-offspring)
- Very rare mega-NUMTs could cause false positives
- Ancient DNA requires higher coverage due to degradation

**Workflow Integration**
------------------------

Recommended pipeline::

    BAM/CRAM → Mutserve Call → VCF → Haplocheck → Contamination Report
                                ↓
                          Haplogrep3 → Haplogroup Classification

**Citation**
------------

If you use Haplocheck in your research, please cite:

Weissensteiner H, Forer L, Fendt L, Kheirkhah A, Salas A, Kronenberg F, Schoenherr S. 
Contamination detection in sequencing studies using the mitochondrial phylogeny. 
Genome Res. 2021;31:309-316. doi:10.1101/gr.256545.119

**Links**
---------

- Web Service: https://mitoverse.i-med.ac.at
- GitHub: https://github.com/genepi/haplocheck
- Documentation: https://mitoverse.readthedocs.io/haplocheck/haplocheck/
    ]]></help>
    <citations>
        <citation type="doi">10.1101/gr.256545.119</citation>
    </citations>
</tool>
